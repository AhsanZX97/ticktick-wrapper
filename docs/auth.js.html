<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>auth.js - Documentation</title>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <span class="navicon"></span>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-Models-List.html">List</a><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="module-Models-List.html#._getAll">_getAll</a></li><li data-type='method'><a href="module-Models-List.html#addSimpleTask">addSimpleTask</a></li></ul></li><li><a href="module-Models-Reminder.html">Reminder</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="module-Models-Reminder.html#.TimeUnit">TimeUnit</a></li></ul></li><li><a href="module-Models-Task.html">Task</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="module-Models-Task.html#.Kind">Kind</a></li><li data-type='member'><a href="module-Models-Task.html#.Priority">Priority</a></li><li data-type='member'><a href="module-Models-Task.html#.Status">Status</a></li></ul><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="module-Models-Task.html#_getAllUncompleted">_getAllUncompleted</a></li><li data-type='method'><a href="module-Models-Task.html#save">save</a></li></ul></li><li><a href="module-TickTick-TickTick.html">TickTick</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="module-TickTick-TickTick.html#_cacheMaxAgeInMinutes">_cacheMaxAgeInMinutes</a></li><li data-type='member'><a href="module-TickTick-TickTick.html#_listsCache">_listsCache</a></li><li data-type='member'><a href="module-TickTick-TickTick.html#_listsCacheLastUpdate">_listsCacheLastUpdate</a></li><li data-type='member'><a href="module-TickTick-TickTick.html#Inbox">Inbox</a></li><li data-type='member'><a href="module-TickTick-TickTick.html#List">List</a></li><li data-type='member'><a href="module-TickTick-TickTick.html#Reminder">Reminder</a></li><li data-type='member'><a href="module-TickTick-TickTick.html#Task">Task</a></li><li data-type='member'><a href="module-TickTick-TickTick.html#user">user</a></li></ul><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="module-TickTick-TickTick.html#_checkListsCache">_checkListsCache</a></li><li data-type='method'><a href="module-TickTick-TickTick.html#_setUserInfo">_setUserInfo</a></li><li data-type='method'><a href="module-TickTick-TickTick.html#changeCacheMaxAge">changeCacheMaxAge</a></li><li data-type='method'><a href="module-TickTick-TickTick.html#createReminder">createReminder</a></li><li data-type='method'><a href="module-TickTick-TickTick.html#getListByName">getListByName</a></li><li data-type='method'><a href="module-TickTick-TickTick.html#getLists">getLists</a></li><li data-type='method'><a href="module-TickTick-TickTick.html#login">login</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-Authentication.html">Authentication</a><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="module-Authentication.html#~assertLogin">assertLogin</a></li><li data-type='method'><a href="module-Authentication.html#~loginEmail">loginEmail</a></li><li data-type='method'><a href="module-Authentication.html#~loginFacebook">loginFacebook</a></li><li data-type='method'><a href="module-Authentication.html#~loginGoogle">loginGoogle</a></li><li data-type='method'><a href="module-Authentication.html#~loginTwitter">loginTwitter</a></li></ul></li><li><a href="module-Connection.html">Connection</a><ul class='members'><li class='list-title'>Members</li><li data-type='member'><a href="module-Connection.html#~baseUri">baseUri</a></li><li data-type='member'><a href="module-Connection.html#~cookieJar">cookieJar</a></li><li data-type='member'><a href="module-Connection.html#~middlewares">middlewares</a></li><li data-type='member'><a href="module-Connection.html#~rpDefaults">rpDefaults</a></li></ul><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="module-Connection.html#~addMiddleware">addMiddleware</a></li><li data-type='method'><a href="module-Connection.html#~clearMiddlewares">clearMiddlewares</a></li><li data-type='method'><a href="module-Connection.html#~removeMiddleware">removeMiddleware</a></li><li data-type='method'><a href="module-Connection.html#~request">request</a></li></ul></li><li><a href="module-Models.html">Models</a></li><li><a href="module-TickTick.html">TickTick</a></li><li><a href="module-Utils.html">Utils</a><ul class='methods'><li class='list-title'>Methods</li><li data-type='method'><a href="module-Utils.html#~formatDate">formatDate</a></li><li data-type='method'><a href="module-Utils.html#~validateCache">validateCache</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">auth.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @module Authentication */

const conn = require('./connection');

/**
 * Error thrown when the client tries to call any function that requires authentication
 * before authenticating.
 * @class
 * @ignore
 */
class NotLoggedInError extends Error {
  constructor() {
    super('A login is necessary before performing any actions');
    this.name = 'NotLoggedInError';
  }
}

/**
 * Error thrown when the parameters in a call to {@link TickTick#login} do not match any
 * valid provider.
 * @class
 * @ignore
 */
class NoLoginProviderSelectedError extends Error {
  constructor() {
    super('The "ptions" parameter does not contain valid data for any provider');
    this.name = 'NoLoginProviderSelectedError';
  }
}

/**
 * Error thrown when the client tries to perform a login using a provider that is not yet
 * supported.
 * @class
 * @ignore
 */
class UnavailableLoginProviderError extends Error {
  constructor(provider) {
    super(`The handler for ${provider} login is not implemented`);
    this.name = 'UnavailableProviderError';
  }
}

/**
 * Error thrown when a login request fails
 * @class
 * @ignore
 * @param {string} message - Error message
 * @param {string} errorId - Error id returned by the failed request
 * @param {string} errorCode - Error code returned by the failed request
 * @param {string} errorMessage - Error message returned by the failed request
 */
class FailedLoginError extends Error {
  constructor(message, errorId, errorCode, errorMessage) {
    super(message);
    this.errorId = errorId;
    this.errorCode = errorCode;
    this.errorMessage = errorMessage;
  }
}

/**
 * Middleware to be executed before each request that ensures the client has already
 * authenticated before calling any methods
 * @private
 * @throws {NotLoggedInError} If the client has not authenticated
 */
const assertLogin = function _assertLoginMiddleware() {
  const cookies = conn.cookieJar.getCookies(conn.baseUri);

  for (let i = 0; i &lt; cookies.length; i += 1) {
    if (cookies[i].key === 't' &amp;&amp; cookies[i].expires > Date.now()) {
      return;
    }
  }

  throw new NotLoggedInError();
};

/**
 * Executes a login operation via e-mail, using an e-mail and a password.
 * @private
 * @param {Object} credentials - Credentials used on login
 * @param {string} credentials.username - E-mail of the account
 * @param {string} credentials.password - Password of the account
 * @throws {FailedLoginError} If the request fails
 */
const loginEmail = async function _loginEmail(credentials) {
  const options = {
    method: 'POST',
    uri: `${conn.baseUri}/user/signon`,
    qs: {
      wc: true,
      remember: true,
    },
    json: true,
    body: credentials,
  };

  try {
    const userInfo = conn.request(options);
    return userInfo;
  } catch (err) {
    const { body } = err.response;
    switch (body.errorCode) {
      case 'username_not_exist':
        throw new FailedLoginError(`The username "${credentials.username}" does not exist`,
          body.errorId, body.errorCode, body.errorMessage);
      case 'username_password_not_match':
        throw new FailedLoginError(`The password provided for the username "${credentials.username}"`
          + ' is incorrect', body.errorId, body.errorCode, body.errorMessage);
      default:
        throw new FailedLoginError('Error on login', body.errorId, body.errorCode,
          body.errorMessage);
    }
  }
};

/**
 * Not implemented
 * @private
 * @throws {UnavailableLoginProviderError}
 */
const loginFacebook = async function _loginFacebook(/* credentials */) {
  throw new UnavailableLoginProviderError('Facebook');
};

/**
 * Not implemented
 * @private
 * @throws {UnavailableLoginProviderError}
 */
const loginGoogle = async function _loginGoogle(/* credentials */) {
  throw new UnavailableLoginProviderError('Google');
};

/**
 * Not implemented
 * @private
 * @throws {UnavailableLoginProviderError}
 */
const loginTwitter = async function _loginTwitter(/* credentials */) {
  throw new UnavailableLoginProviderError('Twitter');
};

module.exports = {
  loginEmail,
  loginFacebook,
  loginGoogle,
  loginTwitter,
  assertLogin,
  errors: {
    NotLoggedInError,
    UnavailableLoginProviderError,
    NoLoginProviderSelectedError,
    FailedLoginError,
  },
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc" target="_blank">JSDoc 3.5.5</a> on 1/15/2019 using the <a href="https://github.com/Grafluxe/boxy-jsdoc-template" target="_blank">boxy-jsdoc-template</a> theme.
</footer>

<script src="scripts/prettify/prettify.js"></script>
<script src="scripts/prettify/lang-css.js"></script>
<script src="scripts/script.js"></script>

</body>
</html>
